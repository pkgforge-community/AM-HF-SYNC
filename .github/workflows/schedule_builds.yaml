name: ⏱️ Schedule Matrix Builds 📈
on:
  workflow_dispatch:
  schedule:
    - cron: "30 18 * * Mon,Wed,Sat" # 06:30 PM UTC (12:15 AM NPT Mrng)
    #- cron: "30 18 * * 1,3,6" # 06:30 PM UTC (12:15 AM NPT Mrng)
jobs:
  pre-trigger-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      build_list: ${{ steps.set-inputs.outputs.build_list }}
    steps:
      - name: Setup Env
        run: |
          ##presets
          set +x ; set +e
          #-------------#
          ##CoreUtils
          sudo apt update -y
          sudo apt install bc coreutils curl dos2unix fdupes jq moreutils wget -y
          sudo apt-get install apt-transport-https apt-utils ca-certificates coreutils dos2unix gnupg2 jq moreutils p7zip-full rename rsync software-properties-common texinfo tmux torsocks util-linux wget zsync -y 2>/dev/null ; sudo apt-get update -y 2>/dev/null
          #-------------#
          ##Host
          HOST_TRIPLET="$(uname -m)-$(uname -s)"
          echo "HOST_TRIPLET=${HOST_TRIPLET}" >> "${GITHUB_ENV}"
          #-------------#
          ##Repo
          PKG_REPO="${GITHUB_REPOSITORY}"
          echo "PKG_REPO=${PKG_REPO#*/}" >> "${GITHUB_ENV}"
          #-------------#
          ##tmp
          SYSTMP="$(dirname $(mktemp -u))" && export SYSTMP="${SYSTMP}"
          echo "SYSTMP=${SYSTMP}" >> "${GITHUB_ENV}"
          #-------------#
          mkdir -p "${HOME}/bin"
          sudo apt update -y
          sudo apt install dos2unix -y
          ##User-Agent
          USER_AGENT="$(curl -qfsSL 'https://pub.ajam.dev/repos/Azathothas/Wordlists/Misc/User-Agents/ua_chrome_macos_latest.txt')" && export USER_AGENT="${USER_AGENT}"
          echo "USER_AGENT=${USER_AGENT}" >> "${GITHUB_ENV}"
        continue-on-error: true
              
      - name: Get & Set Inputs
        id: set-inputs
        run: |
          ##presets
          set +x ; set +e
          #-------------#
          ##Get Data
          mkdir -pv "${SYSTMP}/AM"
          pushd "$(mktemp -d)" &>/dev/null
          #curl -qfsSL "https://raw.githubusercontent.com/pkgforge-community/AM-HF-SYNC/refs/heads/main/programs/aarch64-apps" | cut -d ':' -f1 | tr -cd '[:alnum:]-_\n' | jq -R '{host: "aarch64-Linux", pkg: .}' > "${SYSTMP}/AM/aarch64-Linux.json"
          #curl -qfsSL "https://raw.githubusercontent.com/pkgforge-community/AM-HF-SYNC/refs/heads/main/programs/x86_64-apps" | cut -d ':' -f1 | tr -cd '[:alnum:]-_\n' | jq -R '{host: "x86_64-Linux", pkg: .}' > "${SYSTMP}/AM/x86_64-Linux.json"
          git clone --depth="1" --filter="blob:none" --quiet "https://github.com/ivan-hc/AM"
          find "./AM/programs/x86_64/" -type f -exec basename "{}" 2>/dev/null \; | sort -u | sed -E 's/^[[:space:]]+|[[:space:]]+$//g' | jq -R '{host: "x86_64-Linux", pkg: .}' > "${SYSTMP}/AM/x86_64-Linux.json"
          cat "${SYSTMP}/AM/x86_64-Linux.json" | jq -s 'sort_by(.pkg)' > "${SYSTMP}/AM/LIST.json"
          ##Set Input (100 builds)
          BUILD_LIST="$(jq -c '[.[]] | .[:100]' "${SYSTMP}/AM/LIST.json")"
          ##Validate Input
          if ! echo "${BUILD_LIST}" | jq -e 'type == "array" and length > 0' >/dev/null; then
             echo -e "\n[-] Input Json is likely Invalid\n"
             echo "${BUILD_LIST}" | jq .
            exit 1
          else
             ESCAPED_BUILD_LIST=$(echo "$BUILD_LIST" | jq -c .)
             echo "build_list=${ESCAPED_BUILD_LIST}" >> "${GITHUB_OUTPUT}"
          fi
          popd &>/dev/null
        continue-on-error: false

      - name: Sanity Check Input JSON
        run: |
          echo '${{ steps.set-inputs.outputs.build_list }}' | jq .
        continue-on-error: true

  trigger-build:
    needs: [pre-trigger-build]
    runs-on: ubuntu-latest
    timeout-minutes: 250
    permissions:
      actions: write
      contents: read
      statuses: write
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        package: ${{ fromJSON(needs.pre-trigger-build.outputs.build_list) }}
    steps:
      - name: Current Package
        run: |
          echo '${{ toJSON(matrix.package) }}' | jq -r '
            "Host: \(.host)",
            "Package: \(.pkg)"
          '
        continue-on-error: true

      - name: Trigger Matrix Builds
        if: ${{ toJson(matrix.package) != '{}' }}
        env:
          GH_TOKEN: "${{ github.token }}"
        run: |
          ##presets
          set +x ; set +e
          #-------------#        
          gh workflow run "matrix_builds.yaml" \
            --repo "${GITHUB_REPOSITORY}" \
            --ref "${GITHUB_REF}" \
            -f host="x86_64-Linux" \
            -f pkg-name="${{ matrix.package.pkg }}" \
            -f debug="false" \
            -f logs="true"
        continue-on-error: false